#include "core/core.h"
#include "utils/boot_psi.h"
#include "platform/memory_map.h"
#include "platform/reg_access.h"
#include "dbg/raw_print.h"
#include "hw_regs/crl_apb.h"
#include "hw_regs/crf_apb.h"
#include "hw_regs/dp.h"
#include "hw_regs/serdes.h"
#include "hw_regs/serdes2.h"
#include "hw_regs/usb3_regs.h"
#include "hw_regs/usb3_xhci.h"
#include "hw_regs/pcie_attrib.h"
#include "hw_regs/gpio.h"

__attribute__((__section__(".hwregs")))
static PSI_IWord const put_serdes_in_reset_init[] = {
	PSI_SET_REGISTER_BANK(CRL_APB),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_TOP, 0x00000540U, 0x00000540U),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU0, 0x00000008U, 0x00000008U),
	PSI_FAR_WRITE_MASKED_32(CRF_APB, RST_FPD_TOP, 0x000E0000U, 0x000E0000U),
	PSI_SET_REGISTER_BANK(DP),
	PSI_WRITE_MASKED_32(DP, TX_PHY_POWER_DOWN, 0x0000000FU, 0x0000000AU),
	PSI_WRITE_MASKED_32(DP, PHY_RESET, 0x00000002U, 0x00000002U),
	PSI_FAR_WRITE_MASKED_32(CRF_APB, RST_FPD_TOP, 0x00010000U, 0x00010000U),
	PSI_END_PROGRAM
};


__attribute__((__section__(".hwregs")))
static PSI_IWord const serdes_init[] = {
	PSI_SET_REGISTER_BANK(SERDES2),
	PSI_WRITE_MASKED_32(SERDES2, PLL_REF_SEL0, 0x0000001FU, 0x0000000DU),
	PSI_WRITE_MASKED_32(SERDES2, PLL_REF_SEL1, 0x0000001FU, 0x00000008U),
	PSI_WRITE_MASKED_32(SERDES2, PLL_REF_SEL2, 0x0000001FU, 0x00000009U),
	PSI_WRITE_MASKED_32(SERDES2, PLL_REF_SEL3, 0x0000001FU, 0x00000009U),
	PSI_SET_REGISTER_BANK(SERDES),
	PSI_WRITE_MASKED_32(SERDES, L0_L0_REF_CLK_SEL, 0x00000080U, 0x00000080U),
	PSI_WRITE_MASKED_32(SERDES, L0_L1_REF_CLK_SEL, 0x00000088U, 0x00000008U),
	PSI_WRITE_MASKED_32(SERDES, L0_L2_REF_CLK_SEL, 0x00000080U, 0x00000080U),
	PSI_WRITE_MASKED_32(SERDES, L0_L3_REF_CLK_SEL, 0x00000084U, 0x00000004U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_PLL_DIG_37, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L2_PLL_SS_STEPS_0_LSB, 0x000000FFU, 0x00000058U),
	PSI_WRITE_MASKED_32(SERDES, L2_PLL_SS_STEPS_1_MSB, 0x00000007U, 0x00000003U),
	PSI_WRITE_MASKED_32(SERDES, L3_PLL_SS_STEPS_0_LSB, 0x000000FFU, 0x00000058U),
	PSI_WRITE_MASKED_32(SERDES, L3_PLL_SS_STEPS_1_MSB, 0x00000007U, 0x00000003U),
	PSI_WRITE_MASKED_32(SERDES, L1_PLL_SS_STEPS_0_LSB, 0x000000FFU, 0x00000038U),
	PSI_WRITE_MASKED_32(SERDES, L1_PLL_SS_STEPS_1_MSB, 0x00000007U, 0x00000003U),
	PSI_WRITE_MASKED_32(SERDES, L1_PLL_SS_STEP_SIZE_0_LSB, 0x000000FFU, 0x000000F4U),
	PSI_WRITE_MASKED_32(SERDES, L1_PLL_SS_STEP_SIZE_1, 0x000000FFU, 0x00000031U),
	PSI_WRITE_MASKED_32(SERDES, L1_PLL_SS_STEP_SIZE_2, 0x000000FFU, 0x00000002U),
	PSI_WRITE_MASKED_32(SERDES, L1_PLL_SS_STEP_SIZE_3_MSB, 0x00000033U, 0x00000030U),
	PSI_WRITE_MASKED_32(SERDES, L2_PLL_SS_STEP_SIZE_0_LSB, 0x000000FFU, 0x0000007CU),
	PSI_WRITE_MASKED_32(SERDES, L2_PLL_SS_STEP_SIZE_1, 0x000000FFU, 0x00000033U),
	PSI_WRITE_MASKED_32(SERDES, L2_PLL_SS_STEP_SIZE_2, 0x000000FFU, 0x00000002U),
	PSI_WRITE_MASKED_32(SERDES, L2_PLL_SS_STEP_SIZE_3_MSB, 0x00000033U, 0x00000030U),
	PSI_WRITE_MASKED_32(SERDES, L3_PLL_SS_STEP_SIZE_0_LSB, 0x000000FFU, 0x0000007CU),
	PSI_WRITE_MASKED_32(SERDES, L3_PLL_SS_STEP_SIZE_1, 0x000000FFU, 0x00000033U),
	PSI_WRITE_MASKED_32(SERDES, L3_PLL_SS_STEP_SIZE_2, 0x000000FFU, 0x00000002U),
	PSI_WRITE_MASKED_32(SERDES, L3_PLL_SS_STEP_SIZE_3_MSB, 0x00000033U, 0x00000030U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_DIG_6, 0x00000003U, 0x00000003U),
	PSI_WRITE_MASKED_32(SERDES, L1_TX_DIG_TM_61, 0x00000003U, 0x00000003U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_AUX_0, 0x00000020U, 0x00000020U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_AUX_0, 0x00000020U, 0x00000020U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_DIG_8, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_DIG_8, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_DIG_8, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_DIG_8, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_MISC2, 0x00000080U, 0x00000080U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_IQ_ILL1, 0x000000FFU, 0x00000064U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_IQ_ILL2, 0x000000FFU, 0x00000064U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_ILL12, 0x000000FFU, 0x00000011U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_E_ILL1, 0x000000FFU, 0x00000004U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_E_ILL2, 0x000000FFU, 0x000000FEU),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_IQ_ILL3, 0x000000FFU, 0x00000064U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_E_ILL3, 0x000000FFU, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_ILL8, 0x000000FFU, 0x000000FFU),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_IQ_ILL8, 0x000000FFU, 0x000000F7U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_IQ_ILL9, 0x00000001U, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_E_ILL8, 0x000000FFU, 0x000000F7U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_E_ILL9, 0x00000001U, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_ILL13, 0x00000007U, 0x00000007U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_MISC2, 0x00000080U, 0x00000080U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_IQ_ILL1, 0x000000FFU, 0x0000001AU),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_IQ_ILL2, 0x000000FFU, 0x0000001AU),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_ILL12, 0x000000FFU, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_E_ILL1, 0x000000FFU, 0x000000FEU),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_E_ILL2, 0x000000FFU, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_IQ_ILL3, 0x000000FFU, 0x0000001AU),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_E_ILL3, 0x000000FFU, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_ILL8, 0x000000FFU, 0x000000FFU),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_IQ_ILL8, 0x000000FFU, 0x000000F7U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_IQ_ILL9, 0x00000001U, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_E_ILL8, 0x000000FFU, 0x000000F7U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_E_ILL9, 0x00000001U, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_ILL13, 0x00000007U, 0x00000007U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_ILL13, 0x00000007U, 0x00000007U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_ILL13, 0x00000007U, 0x00000007U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_DIG_10, 0x0000000FU, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_DIG_10, 0x0000000FU, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_DIG_10, 0x0000000FU, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_DIG_10, 0x0000000FU, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_RST_DLY, 0x000000FFU, 0x000000FFU),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_ANA_BYP_15, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_ANA_BYP_12, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_RST_DLY, 0x000000FFU, 0x000000FFU),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_ANA_BYP_15, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_ANA_BYP_12, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_RST_DLY, 0x000000FFU, 0x000000FFU),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_ANA_BYP_15, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_ANA_BYP_12, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_RST_DLY, 0x000000FFU, 0x000000FFU),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_ANA_BYP_15, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_ANA_BYP_12, 0x00000040U, 0x00000040U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_MISC3, 0x00000003U, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_MISC3, 0x00000003U, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_MISC3, 0x00000003U, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_MISC3, 0x00000003U, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L0_TM_EQ11, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L1_TM_EQ11, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L2_TM_EQ11, 0x00000010U, 0x00000010U),
	PSI_WRITE_MASKED_32(SERDES, L3_TM_EQ11, 0x00000010U, 0x00000010U),

	// ill calibration
	// lane 3 = DP
	// lane 2 = DP
	// lane 1 = USB
	// lane 0 = PCIE_GEN2
	PSI_WRITE_32(SERDES, L1_TM_IQ_ILL8,0xF3),
	PSI_WRITE_32(SERDES, L1_TM_E_ILL8,0xF3),
	PSI_WRITE_32(SERDES, L1_TM_ILL12,0x20),
	PSI_WRITE_32(SERDES, L1_TM_E_ILL1,0x37),

	PSI_FAR_WRITE_MASKED_32(SIOU, ECO_0, 0xFFFFFFFFU, 0x00000001U),
	PSI_FAR_WRITE_MASKED_32(SERDES2, ICM_CFG0, 0x00000077U, 0x00000031U),
	PSI_FAR_WRITE_MASKED_32(SERDES2, ICM_CFG1, 0x00000077U, 0x00000044U),
	PSI_WRITE_MASKED_32(SERDES, L2_TXPMD_TM_45, 0x00000037U, 0x00000037U),
	PSI_WRITE_MASKED_32(SERDES, L3_TXPMD_TM_45, 0x00000037U, 0x00000037U),
	PSI_WRITE_MASKED_32(SERDES, L2_TX_ANA_TM_118, 0x00000001U, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L3_TX_ANA_TM_118, 0x00000001U, 0x00000001U),
	PSI_WRITE_MASKED_32(SERDES, L2_TXPMD_TM_48, 0x0000001FU, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L3_TXPMD_TM_48, 0x0000001FU, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L2_TX_ANA_TM_18, 0x000000FFU, 0x00000000U),
	PSI_WRITE_MASKED_32(SERDES, L3_TX_ANA_TM_18, 0x000000FFU, 0x00000000U),
	PSI_END_PROGRAM
};

__attribute__((__section__(".hwregs")))
static PSI_IWord const take_serdes_out_of_reset_init[] = {
	PSI_FAR_WRITE_MASKED_32(CRL_APB, RST_LPD_TOP, 0x00000400U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(USB3, FPD_POWER_PRSNT, 0x00000001U, 0x00000001U),
	PSI_FAR_WRITE_MASKED_32(USB3, FPD_PIPE_CLK, 0x00000001U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(CRL_APB, RST_LPD_TOP, 0x00000140U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU0, 0x00000008U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(CRF_APB, RST_FPD_TOP, 0x000C0000U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(CRF_APB, RST_FPD_TOP, 0x00010000U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(DP,PHY_RESET, 0x00000002U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(DP,TX_PHY_POWER_DOWN, 0x0000000FU, 0x00000000U),

	PSI_SET_REGISTER_BANK(USB3_0_XHCI),
	PSI_WRITE_MASKED_32(USB3_0_XHCI, GUSB2PHYCFG, 0x00023FFFU, 0x00022457U),
	PSI_WRITE_MASKED_32(USB3_0_XHCI, GFLADJ, 0x003FFF00U, 0x00000000U),
	PSI_WRITE_MASKED_32(USB3_0_XHCI, GUCTL1, 0x00000600U, 0x00000600U),
	PSI_WRITE_MASKED_32(USB3_0_XHCI, GUCTL, 0x00004000U, 0x00004000U),

	PSI_FAR_WRITE_MASKED_32(CRF_APB, RST_FPD_TOP, 0x00020000U, 0x00000000U),
	PSI_FAR_WRITE_MASKED_32(GPIO, MASK_DATA_1_LSW, 0xFFFFFFFFU, 0xFFDF0020U),

	// lane 3 = DP
	// lane 2 = DP (locked with lane 3)
	// lane 1 = USB
	// lane 0 = PCIE_GEN2 (not used)
	PSI_SET_REGISTER_BANK(SERDES),
//	PSI_POLL_MASKED_32(SERDES, L1_PLL_STATUS_READ_1, HW_REG_FIELD_MASK(SERDES, L1_PLL_STATUS_READ_1, PLL_LOCK_STATUS_READ) ),
	PSI_POLL_MASKED_32(SERDES, L3_PLL_STATUS_READ_1, HW_REG_FIELD_MASK(SERDES, L3_PLL_STATUS_READ_1, PLL_LOCK_STATUS_READ) ),

	PSI_END_PROGRAM
};

#define MASK_POLL_TIME 1100000

void serdes_fixcal(void)
{
	uint32_t rdata = 0;

	// Each element of array stands for count of occurrence of valid code.

	// The valid codes are from 0x26 to 0x3C. There are 23 valid codes in total.
	uint32_t match_pmos_code[23] = { 0 };
	uint32_t match_nmos_code[23] = { 0 };
	// The valid codes are from 0xC to 0x12. There are 7 valid codes in total.
	uint32_t match_ical_code[7] = { 0 };
	// The valid codes are from 0x6 to 0xC. There are 7 valid codes in total.
	uint32_t match_rcal_code[7] = { 0 };

	uint32_t p_code = 0;
	uint32_t n_code = 0;
	uint32_t i_code = 0;
	uint32_t r_code = 0;
	uint32_t repeat_count = 0;
	int i = 0;

	HW_REG_MERGE(SERDES, UNKNOWN0, 0x3, 0x1);

	// check supply good status before starting AFE sequencing
	int count = 0;
	do
	{
		if (count == MASK_POLL_TIME )
			break;
		rdata = HW_REG_READ1(SERDES, POWER_GOOD);
		count++;
	}while((rdata&0x0000000E) !=0x0000000E);

	do {
		//Clear ICM_CFG value
		HW_REG_WRITE1(SERDES2, ICM_CFG0, 0x00000000);
		HW_REG_WRITE1(SERDES2, ICM_CFG1, 0x00000000);

		//Set ICM_CFG value
		//This will trigger re-calibration of all stages
		HW_REG_WRITE1(SERDES2, ICM_CFG0, 0x00000001);
		HW_REG_WRITE1(SERDES2, ICM_CFG1, 0x00000000);

		// is calibration done? polling on L3_CALIB_DONE_STATUS
		count = 0;
		do {
			if (count == MASK_POLL_TIME ) {
				raw_debug_printf("SERDES initialization timed out\n\r");
				return;
			}
			rdata = HW_REG_READ1(SERDES, L3_CALIB_DONE_STATUS) & 0x2;
			count++;
		} while( !rdata );

		p_code = HW_REG_READ1(SERDES, PMOS_CODE);
		n_code = HW_REG_READ1(SERDES, NMOS_CODE);
		//m_code = HW_REG_READ1(SERDES, MPHY_CODE);
		i_code = HW_REG_READ1(SERDES, ICAL_CODE);
		r_code = HW_REG_READ1(SERDES, RX_CODE);
		//u_code = HW_REG_READ1(SERDES, USB2_CODE);

		// PMOS code in acceptable range
		if ((p_code >= 0x26) && (p_code <= 0x3C))
			match_pmos_code[p_code - 0x26] += 1;

		// NMOS code in acceptable range
		if ((n_code >= 0x26) && (n_code <= 0x3C))
			match_nmos_code[n_code - 0x26] += 1;

		// ical code in acceptable range
		if ((i_code >= 0xC) && (i_code <= 0x12))
			match_ical_code[i_code - 0xC] += 1;

		// rcal code in acceptable range
		if ((r_code >= 0x6) && (r_code <= 0xC))
			match_rcal_code[r_code - 0x6] += 1;

	} while (repeat_count++ < 10);

	// find the valid code which resulted in maximum times in 10 iterations
	for (i = 0; i < 23; i++) {
		if (match_pmos_code[i] >= match_pmos_code[0]) {
			match_pmos_code[0] = match_pmos_code[i];
			p_code = 0x26 + i;
		}
	if (match_nmos_code[i] >= match_nmos_code[0]) {
		match_nmos_code[0] = match_nmos_code[i];
		n_code = 0x26 + i;
		}
	}

	for (i = 0; i < 7; i++) {
		if (match_ical_code[i] >= match_ical_code[0]) {
			match_ical_code[0] = match_ical_code[i];
			i_code = 0xC + i;
		}
		if (match_rcal_code[i] >= match_rcal_code[0]) {
			match_rcal_code[0] = match_rcal_code[i];
			r_code = 0x6 + i;
		}
	}

	// L3_TM_CALIB_DIG20[3] PSW MSB Override
	// L3_TM_CALIB_DIG20[2:0]	PSW Code [4:2]
	HW_REG_MERGE(SERDES, L3_TM_CALIB_DIG20, 0xF, (0x8 | ((p_code >> 2) & 0x7)) );

	// L3_TM_CALIB_DIG19[7:6]	PSW Code [1:0]
	// L3_TM_CALIB_DIG19[5]	PSW Override
	// L3_TM_CALIB_DIG19[2]	NSW MSB Override
	// L3_TM_CALIB_DIG19[1:0]	NSW Code [4:3]
	HW_REG_MERGE(SERDES, L3_TM_CALIB_DIG19, 0xE7, ((p_code & 0x3) << 6) | 0x20 | 0x4 | ((n_code >> 3) & 0x3) );

	// L3_TM_CALIB_DIG18[7:5]	NSW Code [2:0]
	// L3_TM_CALIB_DIG18[4]	NSW Override
	HW_REG_MERGE(SERDES, L3_TM_CALIB_DIG18, 0xF0, (((n_code & 0x7) << 5) | 0x10) );


	// L3_TM_CALIB_DIG16[2:0]	RX Code [3:1]
	HW_REG_MERGE(SERDES, L3_TM_CALIB_DIG16, 0x7, ((r_code >> 1) & 0x7) );

	// L3_TM_CALIB_DIG15[7]	RX Code [0]
	// L3_TM_CALIB_DIG15[6]	RX CODE Override
	// L3_TM_CALIB_DIG15[3]	ICAL MSB Override
	// L3_TM_CALIB_DIG15[2:0]	ICAL Code [3:1]
	HW_REG_MERGE(SERDES, L3_TM_CALIB_DIG15, 0xCF, ((r_code & 0x1) << 7) | 0x40 | 0x8 | ((i_code >> 1) & 0x7) );

	// L3_TM_CALIB_DIG14[7]	ICAL Code [0]
	// L3_TM_CALIB_DIG14[6]	ICAL Override
	HW_REG_MERGE(SERDES, L3_TM_CALIB_DIG14, 0xC0, ((i_code & 0x1) << 7) | 0x40 );

	// Enable PLL Coarse Code saturation Logic
	HW_REG_WRITE1(SERDES, L0_TM_PLL_DIG_37, 0x00000010);
	HW_REG_WRITE1(SERDES, L1_TM_PLL_DIG_37, 0x00000010);
	HW_REG_WRITE1(SERDES, L2_TM_PLL_DIG_37, 0x00000010);
	HW_REG_WRITE1(SERDES, L3_TM_PLL_DIG_37, 0x00000010);
}

void serdesRunInitProgram(void)
{
	raw_debug_printf("TODO: USB3 PLL is not locking, so disabled for now\r\n");

	psi_RunRegisterProgram(put_serdes_in_reset_init);

	serdes_fixcal();

	psi_RunRegisterProgram(serdes_init);

	psi_RunRegisterProgram(take_serdes_out_of_reset_init);

}