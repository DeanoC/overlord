#include "core/core.h"
#include "hw/reg_access.h"
#include "hw/boot_psi.h"
#include "hw/memory_map.h"
#include "hw_regs/crl_apb.h"
#include "hw_regs/crf_apb.h"

__attribute__((__section__(".hwregs")))
static PSI_IWord const pll_init[] = {
		PSI_SET_REGISTER_BANK(CRL_APB),

		PSI_WRITE_MASKED_32(CRL_APB, PSSYSMON_REF_CTRL, 0x013F3F07U, 0x01012302U),
		PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU2, 0x00000001U, 0x00000001U),

		PSI_WRITE_MASKED_32(CRL_APB, RPLL_CFG, 0xFE7FEDEFU, 0x7E60EC6CU),
		PSI_WRITE_MASKED_32(CRL_APB, RPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, POST_SRC) |
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, PRE_SRC) |
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, DIV2) |
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, FBDIV),

												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, POST_SRC, 0) |  // PS_REF_CLK 33.3Mhz
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, PRE_SRC, 0) |     // PS_REF_CLK
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, DIV2, 1) |        // / 2
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, FBDIV, 0x30)      // / 48 = 33.3 * 24 = 800Mhz
												),
		PSI_WRITE_MASKED_32(CRL_APB, RPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, BYPASS),
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, BYPASS, 1)),
		PSI_WRITE_MASKED_32(CRL_APB, RPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, RESET),
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, RESET, 1)),
		PSI_WRITE_MASKED_32(CRL_APB, RPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, RESET),
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, RESET, 0)),
		PSI_POLL_MASKED_32(CRL_APB, PLL_STATUS, CRL_APB_PLL_STATUS_RPLL_LOCK_MASK),
		PSI_WRITE_MASKED_32(CRL_APB, RPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, RPLL_CTRL, BYPASS),
												HW_REG_ENCODE_FIELD(CRL_APB, RPLL_CTRL, BYPASS, 0)),
		PSI_WRITE_MASKED_32(CRL_APB, RPLL_TO_FPD_CTRL, 0x00003F00U, 0x00000200U),

		PSI_WRITE_MASKED_32(CRL_APB, PSSYSMON_REF_CTRL, 0x013F3F07U, 0x01012300U),

		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_CFG, CRL_APB_IOPLL_CFG_USERMASK, 0x7E4B0C82U),
		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, POST_SRC) |
														HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, PRE_SRC) |
														HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, DIV2) |
														HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, FBDIV),

												HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, POST_SRC, 0) |  // PS_REF_CLK 33.3Mhz
														HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, PRE_SRC, 0) |     // PS_REF_CLK
														HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, DIV2, 1) |        // / 2
														HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, FBDIV, 0x5A)      // / 90 = 33.3 * 45 = 1500Mhz
		),
		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, BYPASS),
												HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, BYPASS, 1)),
		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, RESET),
												HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, RESET, 1)),
		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, RESET),
												HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, RESET, 0)),
		PSI_POLL_MASKED_32(CRL_APB, PLL_STATUS, CRL_APB_PLL_STATUS_IOPLL_LOCK_MASK),
		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_CTRL,
												HW_REG_FIELD_MASK(CRL_APB, IOPLL_CTRL, BYPASS),
												HW_REG_ENCODE_FIELD(CRL_APB, IOPLL_CTRL, BYPASS, 0)),
		PSI_WRITE_MASKED_32(CRL_APB, IOPLL_TO_FPD_CTRL, CRL_APB_IOPLL_TO_FPD_CTRL_DIVISOR0_MASK, 0x00000300U),

		PSI_SET_REGISTER_BANK(CRF_APB),

		PSI_WRITE_MASKED_32(CRF_APB, APLL_CFG, 0xFE7FEDEFU, 0x7E4B0C62U),
		PSI_WRITE_MASKED_32(CRF_APB, APLL_CTRL, 0x00717F00U, 0x00014800U),
		PSI_WRITE_MASKED_32(CRF_APB, APLL_CTRL, 0x00000008U, 0x00000008U),
		PSI_WRITE_MASKED_32(CRF_APB, APLL_CTRL, 0x00000001U, 0x00000001U),
		PSI_WRITE_MASKED_32(CRF_APB, APLL_CTRL, 0x00000001U, 0x00000000U),
		PSI_POLL_MASKED_32(CRF_APB, PLL_STATUS, 0x00000001U),
		PSI_WRITE_MASKED_32(CRF_APB, APLL_CTRL, 0x00000008U, 0x00000000U),
		PSI_WRITE_MASKED_32(CRF_APB, APLL_TO_LPD_CTRL, 0x00003F00U, 0x00000300U),

		PSI_WRITE_MASKED_32(CRF_APB, DPLL_CFG, 0xFE7FEDEFU, 0x7E4B0C62U),
		PSI_WRITE_MASKED_32(CRF_APB, DPLL_CTRL, 0x00717F00U, 0x00014800U),
		PSI_WRITE_MASKED_32(CRF_APB, DPLL_CTRL, 0x00000008U, 0x00000008U),
		PSI_WRITE_MASKED_32(CRF_APB, DPLL_CTRL, 0x00000001U, 0x00000001U),
		PSI_WRITE_MASKED_32(CRF_APB, DPLL_CTRL, 0x00000001U, 0x00000000U),
		PSI_POLL_MASKED_32(CRF_APB, PLL_STATUS, 0x00000002U),
		PSI_WRITE_MASKED_32(CRF_APB, DPLL_CTRL, 0x00000008U, 0x00000000U),
		PSI_WRITE_MASKED_32(CRF_APB, DPLL_TO_LPD_CTRL, 0x00003F00U, 0x00000300U),

		PSI_WRITE_MASKED_32(CRF_APB, VPLL_CFG, 0xFE7FEDEFU, 0x7E4B0C82U),
		PSI_WRITE_MASKED_32(CRF_APB, VPLL_CTRL, 0x00717F00U, 0x00015A00U),
		PSI_WRITE_MASKED_32(CRF_APB, VPLL_CTRL, 0x00000008U, 0x00000008U),
		PSI_WRITE_MASKED_32(CRF_APB, VPLL_CTRL, 0x00000001U, 0x00000001U),
		PSI_WRITE_MASKED_32(CRF_APB, VPLL_CTRL, 0x00000001U, 0x00000000U),
		PSI_POLL_MASKED_32(CRF_APB, PLL_STATUS, 0x00000004U),
		PSI_WRITE_MASKED_32(CRF_APB, VPLL_CTRL, 0x00000008U, 0x00000000U),
		PSI_WRITE_MASKED_32(CRF_APB, VPLL_TO_LPD_CTRL, 0x00003F00U, 0x00000300U),

		PSI_END_PROGRAM
};
void pllRunInitProgram() {
	psi_run_register_program(pll_init);
}