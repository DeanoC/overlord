#include "core/core.h"
#include "utils/boot_psi.h"
#include "platform/memory_map.h"
#include "hw_regs/uart.h"
#include "hw_regs/crl_apb.h"
#include "hw_regs/crf_apb.h"
#include "hw_regs/iou_slcr.h"
#include "hw_regs/iou_scntrs.h"
#include "hw_regs/lpd_slcr_secure.h"
#include "hw_regs/gpio.h"
#include "hw_regs/apu.h"
#include "hw_regs/csu.h"
#include "hw_regs/rtc.h"

#define CRL_APB_BOOT_PIN_CTRL_OFFSET 			0x250U

__attribute__((__section__(".hwregs")))
static PSI_IWord const mio_init[] = {
   PSI_SET_REGISTER_BANK(IOU_SLCR),

   PSI_MULTI_WRITE_MASKED_16(IOU_SLCR, MIO_PIN_0, 78, 0x000000FEU,
	   PSI_PACK_16(0x02U, 0x02U), // 0, 1
	   PSI_PACK_16(0x02U, 0x02U), // 2, 3
	   PSI_PACK_16(0x02U, 0x02U), // 4, 5
	   PSI_PACK_16(0x00U, 0x00U), // 6, 7
	   PSI_PACK_16(0x00U, 0x00U), // 8, 9
	   PSI_PACK_16(0x00U, 0x00U), // 10, 11
	   PSI_PACK_16(0x00U, 0x08U), // 12, 13
	   PSI_PACK_16(0x08U, 0x08U), // 14, 15
	   PSI_PACK_16(0x08U, 0x00U), // 16, 17
	   PSI_PACK_16(0x00U, 0x00U), // 18, 19
	   PSI_PACK_16(0x00U, 0x08U), // 20, 21
	   PSI_PACK_16(0x08U, 0x08U), // 22, 23
	   PSI_PACK_16(0x20U, 0x20U), // 24, 25
	   PSI_PACK_16(0x00U, 0x18U), // 26, 27
	   PSI_PACK_16(0x18U, 0x18U), // 28, 29
	   PSI_PACK_16(0x18U, 0x00U), // 30, 31
	   PSI_PACK_16(0x40U, 0x40U), // 32, 33
	   PSI_PACK_16(0xC0U, 0xC0U), // 34, 35
	   PSI_PACK_16(0x00U, 0x00U), // 36, 37
	   PSI_PACK_16(0x00U, 0x00U), // 38, 39
	   PSI_PACK_16(0x00U, 0x00U), // 40, 41
	   PSI_PACK_16(0x40U, 0x40U), // 42, 43
	   PSI_PACK_16(0x10U, 0x10U), // 44, 45
	   PSI_PACK_16(0x10U, 0x10U), // 46, 47
	   PSI_PACK_16(0x10U, 0x10U), // 48, 49
	   PSI_PACK_16(0x10U, 0x10U), // 50, 51
	   PSI_PACK_16(0x40U, 0x40U), // 52, 53
	   PSI_PACK_16(0x40U, 0x40U), // 54, 55
	   PSI_PACK_16(0x40U, 0x40U), // 56, 57
	   PSI_PACK_16(0x40U, 0x40U), // 58, 59
	   PSI_PACK_16(0x40U, 0x40U), // 60, 61
	   PSI_PACK_16(0x40U, 0x40U), // 62, 63
	   PSI_PACK_16(0x02U, 0x02U), // 64, 65
	   PSI_PACK_16(0x02U, 0x02U), // 66, 67
	   PSI_PACK_16(0x02U, 0x02U), // 68, 69
	   PSI_PACK_16(0x02U, 0x02U), // 70, 71
	   PSI_PACK_16(0x02U, 0x02U), // 72, 73
	   PSI_PACK_16(0x02U, 0x02U), // 74, 75
	   PSI_PACK_16(0xC0U, 0xC0U)  // 76, 77
   ),

   PSI_MULTI_WRITE_32(IOU_SLCR, MIO_MST_TRI0, 3,
		   0x52000000U,
		   0x00B03004U,
		   0x00000FC0U),

   PSI_MULTI_WRITE_MASKED_32(IOU_SLCR, BANK0_CTRL0, 2, 0x03FFFFFFU,
		   0x03FFFFFFU,
		   0x03FFFFFFU),
   PSI_MULTI_WRITE_MASKED_32(IOU_SLCR, BANK0_CTRL3, 5, 0x03FFFFFFU,
		   0x00000000U,
		   0x03FFFFFFU,
		   0x03FFFFFFU,
		   0x00000000U),
   PSI_MULTI_WRITE_MASKED_32(IOU_SLCR, BANK1_CTRL0, 2, 0x03FFFFFFU,
		   0x03FFFFFFU,
		   0x03FFFFFFU),
   PSI_MULTI_WRITE_MASKED_32(IOU_SLCR, BANK1_CTRL3, 5, 0x03FFFFFFU,
		   0x00000000U,
		   0x03FFFFFFU,
		   0x03FFFFFFU,
		   0x00000000U),
   PSI_MULTI_WRITE_MASKED_32(IOU_SLCR, BANK2_CTRL0, 2, 0x03FFFFFFU,
		   0x03FFFFFFU,
		   0x03FFFFFFU),
   PSI_MULTI_WRITE_MASKED_32(IOU_SLCR, BANK2_CTRL3, 5, 0x03FFFFFFU,
		   0x00000000U,
		   0x03FFFFFFU,
		   0x03FFFFFFU,
		   0x00000000U),

   PSI_WRITE_MASKED_32(IOU_SLCR, MIO_LOOPBACK, 0x0000000FU, 0x00000000U),

   PSI_END_PROGRAM
};

__attribute__((__section__(".hwregs")))
static PSI_IWord const peripherals_init[] = {
	PSI_FAR_WRITE_MASKED_32(CRF_APB, RST_FPD_TOP, 0x000F807CU, 0x00000000U),

	PSI_SET_REGISTER_BANK(CRL_APB),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU2, 0x001A0000U, 0x00000000U),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_TOP, 0x0093C018U, 0x00000000U),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU0, 0x00000008U, 0x00000000U),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU2, 0x00000001U, 0x00000000U),

	PSI_FAR_WRITE_MASKED_32(IOU_SLCR, IOU_TAPDLY_BYPASS, 0x00000004U, 0x00000000U),

	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_TOP, 0x00000400U, 0x00000000U),
	PSI_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU2, 0x00000060U, 0x00000000U),

	PSI_SET_REGISTER_BANK(IOU_SLCR),
	PSI_WRITE_MASKED_32(IOU_SLCR ,CTRL_REG_SD, 0x00008001U, 0x00000001U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_CONFIG_REG2, 0x33843384U, 0x00801080U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_CONFIG_REG1, 0x00007FFEU, 0x00006450U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_DLL_CTRL, 0x00080000U, 0x00080000U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_CONFIG_REG1, 0x7FFE0000U, 0x64500000U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_DLL_CTRL, 0x00000008U, 0x00000008U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_CONFIG_REG3, 0x000003C0U, 0x00000000U),
	PSI_WRITE_MASKED_32(IOU_SLCR ,SD_CONFIG_REG3, 0x03C00000U, 0x00000000U),

	PSI_FAR_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU2, 0x0000FF02U, 0x00000000U),

	PSI_SET_REGISTER_BANK(UART_DEBUG),
	PSI_WRITE_MASKED_32(UART_DEBUG, BAUD_RATE_DIVIDER, 0x000000FFU, 0x00000006U),
	PSI_WRITE_MASKED_32(UART_DEBUG, BAUD_RATE_GEN, 0x0000FFFFU, 0x0000007CU),
	PSI_WRITE_MASKED_32(UART_DEBUG, CONTROL, 0x000001FFU, 0x00000017U),
	PSI_WRITE_MASKED_32(UART_DEBUG, MODE, 0x000003FFU, 0x00000020U),

	PSI_FAR_WRITE_MASKED_32(CRL_APB, RST_LPD_IOU2, 0x00040000U, 0x00000000U),

	PSI_FAR_WRITE_MASKED_32(LPD_SLCR_SECURE, SLCR_ADMA, 0x000000FFU, 0x000000FFU),

	PSI_FAR_WRITE_MASKED_32(CSU, TAMPER_STATUS, 0x00001FFFU, 0x00000000U),

	PSI_FAR_WRITE_MASKED_32(APU, ACE_CTRL, 0x000F000FU, 0x00000000U),

	PSI_FAR_WRITE_MASKED_32(RTC, CONTROL, 0x80000000U, 0x80000000U),

	PSI_FAR_WRITE_MASKED_32(IOU_SCNTRS, BASE_FREQUENCY_ID_REGISTER, 0xFFFFFFFFU, 0x01FC9F08U),
	PSI_FAR_WRITE_MASKED_32(IOU_SCNTRS, COUNTER_CONTROL_REGISTER, 0x00000001U, 0x00000001U),

	PSI_SET_REGISTER_BANK(CRL_APB),
	PSI_WRITE_MASKED_32(CRL_APB, BOOT_PIN_CTRL, 0x00000F0FU, 0x00000202U),
	PSI_DELAY_US(1),
	PSI_WRITE_MASKED_32(CRL_APB, BOOT_PIN_CTRL, 0x00000F0FU, 0x00000002U),
	PSI_DELAY_US(5),
	PSI_WRITE_MASKED_32(CRL_APB, BOOT_PIN_CTRL, 0x00000F0FU, 0x00000202U),

	PSI_SET_REGISTER_BANK(GPIO),
	PSI_WRITE_MASKED_32(GPIO, DIRM_1, 0x03FFFFFFU, 0x00000020U),
	PSI_WRITE_MASKED_32(GPIO, OEN_1, 0x03FFFFFFU, 0x00000020U),
	PSI_WRITE_MASKED_32(GPIO, MASK_DATA_1_LSW, 0xFFFFFFFFU, 0xFFDF0020U),
	PSI_DELAY_US(1),
	PSI_WRITE_MASKED_32(GPIO, MASK_DATA_1_LSW, 0xFFFFFFFFU, 0xFFDF0000U),
	PSI_DELAY_US(5),
	PSI_WRITE_MASKED_32(GPIO, DIRM_1, 0x03FFFFFFU, 0x00000020U),
	PSI_WRITE_MASKED_32(GPIO, OEN_1, 0x03FFFFFFU, 0x00000020U),
	PSI_WRITE_MASKED_32(GPIO, MASK_DATA_1_LSW, 0xFFFFFFFFU, 0xFFDF0000U),

   PSI_END_PROGRAM
};

void mioRunInitProgram()
{
  psi_RunRegisterProgram(mio_init);
}

void peripheralsRunInitProgram()
{
  psi_RunRegisterProgram(peripherals_init);
}